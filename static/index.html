<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agente turístico</title>
  <link rel="stylesheet" href="/static/styles.css"/>
</head>
<body>
  <div class="chat-container">
    <header class="chat-header">
      <h1>Agente turístico conversacional</h1>
      <p>Tu asistente personal para planificar viajes</p>
    </header>

    <main id="chat-box" class="chat-box">
      <!-- Mensaje inicial -->
      <div class="message bot">
        ¡Hola! Soy tu agente turístico. Pregúntame por clima, costos, lugares o un <b>itinerario</b> indicando días y, si quieres, un <b>tema</b> (arte, foodie, low-cost, familiar).<br/>
        Ej.: <i>“itinerario 4 días a Roma, tema: foodie”</i>
      </div>
    </main>

    <form id="chat-form" class="chat-form">
      <input type="text" id="question" name="question" placeholder="Escribe tu pregunta de viaje..." required/>
      <button type="submit">Enviar</button>
    </form>

    <footer class="chat-footer">
      © 2025 Planificador de Viajes - Proyecto educativo
    </footer>
  </div>

  <script>
    const form = document.getElementById('chat-form');
    const chatBox = document.getElementById('chat-box');

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      // si es respuesta del bot, intentamos formatear
      if (sender === 'bot') {
        const formatted = formatBotAnswer(text);
        div.appendChild(formatted);
      } else {
        div.textContent = text;
      }
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function formatBotAnswer(answer) {
      const wrapper = document.createElement('div');

      // si incluye "Itinerario de" y "- Día", lo formateamos como itinerario
      const isItinerary = /Itinerario de\s+\d+\s+d[ií]as/i.test(answer) && /- Día\s*\d+/i.test(answer);

      if (!isItinerary) {
        // Fallback: muestra con saltos de línea
        wrapper.innerHTML = safeTextToHTML(answer);
        return wrapper;
      }

      // 1) Separamos cabecera, bloques de días y nota final
      const lines = answer.split('\n').map(l => l.trim()).filter(Boolean);

      // Cabecera (ej: "Itinerario de X días en Y — Tema: Z")
      const headerIdx = lines.findIndex(l => /^Itinerario de\s+\d+\s+d[ií]as/i.test(l));
      const headerText = headerIdx >= 0 ? lines[headerIdx] : 'Itinerario';

      const headerEl = document.createElement('div');
      headerEl.className = 'itinerary-header';
      headerEl.textContent = headerText;
      wrapper.appendChild(headerEl);

      // Extra (bloque "Incluye:" si existe)
      const incluyeStart = lines.findIndex(l => /^Incluye:$/i.test(l));
      let incluyeList = [];
      if (incluyeStart >= 0) {
        for (let i = incluyeStart + 1; i < lines.length; i++) {
          const li = lines[i];
          if (!li.startsWith('•')) break;
          incluyeList.push(li.replace(/^•\s*/, ''));
        }
      }
      if (incluyeList.length) {
        const aside = document.createElement('div');
        aside.className = 'itinerary-aside';
        const title = document.createElement('div');
        title.className = 'aside-title';
        title.textContent = 'Incluye';
        const ul = document.createElement('ul');
        incluyeList.forEach(txt => {
          const li = document.createElement('li');
          li.textContent = txt;
          ul.appendChild(li);
        });
        aside.appendChild(title);
        aside.appendChild(ul);
        wrapper.appendChild(aside);
      }

      // 2) Extraemos tarjetas por día: comienzan con "- Día N"
      const dayBlocks = [];
      let current = [];
      for (const l of lines) {
        if (/^- Día\s*\d+/i.test(l)) {
          if (current.length) dayBlocks.push(current);
          current = [l];
        } else if (current.length) {
          // sólo agregamos mientras estemos dentro de un bloque de día
          if (/^(Incluye:|ℹ Nota:)/i.test(l)) {
            // fin lógico de días
            continue;
          }
          current.push(l);
        }
      }
      if (current.length) dayBlocks.push(current);

      // 3) Renderizamos cada bloque en una tarjeta
      const grid = document.createElement('div');
      grid.className = 'itinerary-grid';

      dayBlocks.forEach(block => {
        const card = document.createElement('article');
        card.className = 'itinerary-card';

        // Título del día
        const titleLine = block.find(l => /^- Día\s*\d+/i.test(l)) || '- Día';
        const dayTitle = document.createElement('h3');
        dayTitle.textContent = titleLine.replace(/^- /, '');
        card.appendChild(dayTitle);

        // Mañana/Tarde/Noche/Tip
        const morning = block.find(l => /^Mañana:/i.test(l));
        const afternoon = block.find(l => /^Tarde:/i.test(l));
        const night = block.find(l => /^Noche:/i.test(l));
        const tip = block.find(l => /^Tip:/i.test(l));

        if (morning) card.appendChild(makeRow('Mañana', morning.replace(/^Mañana:\s*/i, '')));
        if (afternoon) card.appendChild(makeRow('Tarde', afternoon.replace(/^Tarde:\s*/i, '')));
        if (night) card.appendChild(makeRow('Noche', night.replace(/^Noche:\s*/i, '')));
        if (tip) card.appendChild(makeRow('Tip', tip.replace(/^Tip:\s*/i, '')));

        grid.appendChild(card);
      });

      wrapper.appendChild(grid);

      // 4) Si hay descargo/nota final, lo mostramos al final
      const disclaimer = lines.find(l => /^ℹ Nota:/i.test(l));
      if (disclaimer) {
        const note = document.createElement('div');
        note.className = 'disclaimer';
        note.textContent = disclaimer;
        wrapper.appendChild(note);
      }

      return wrapper;
    }

    function makeRow(label, text) {
      const row = document.createElement('div');
      row.className = 'itinerary-row';
      const k = document.createElement('span');
      k.className = 'row-key';
      k.textContent = label + ':';
      const v = document.createElement('span');
      v.className = 'row-val';
      v.textContent = text;
      row.appendChild(k);
      row.appendChild(v);
      return row;
    }

    // Escapa texto y respeta saltos de línea simples
    function safeTextToHTML(text) {
      const esc = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      return esc.replace(/\n/g, '<br/>');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = document.getElementById('question').value.trim();
      if (!question) return;

      addMessage(question, 'user');
      document.getElementById('question').value = '';

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });
        if (!res.ok) throw new Error('Error del servidor');
        const data = await res.json();
        addMessage(data.answer || 'Sin respuesta', 'bot');
      } catch (err) {
        addMessage('Ocurrió un error. Intenta nuevamente.', 'bot');
      }
    });
  </script>
</body>
</html>



